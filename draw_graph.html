<html>
  <head>
    <title>Draw Graph</title>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjs/9.2.0/math.js'></script> 
    <script type="module">
      // import latest release from npm repository 
      import {InfluxDB, Point} from 'https://unpkg.com/@influxdata/influxdb-client/dist/index.browser.mjs'
      import {PingAPI, SetupAPI} from 'https://unpkg.com/@influxdata/influxdb-client-apis/dist/index.browser.mjs'
      // or use the following imports to use local builds
      // import {InfluxDB, Point} from '../packages/core/dist/index.browser.mjs'
      // import {PingAPI, SetupAPI} from '../packages/apis/dist/index.browser.mjs'
      import './env_browser.js'
      const {url, token, org, bucket, username, password} = window.INFLUX_ENV

      const influxDB = new InfluxDB({url, token})

      // log results also to HTML page
      const logField = document.getElementById('log');

      //create a matrix to save graph data
      var graph_matrix = []

      function log(message, ...rest){
        console.log(arguments[0],rest)
        const previousValue = logField.value
        logField.value += (previousValue?'\n':'')+Array.prototype.slice.call(arguments).join('\n')
        // scroll to bottom with latest results
        logField.scrollTo(0,logField.scrollHeight <= logField.offsetHeight ? 0 : logField.scrollHeight-logField.offsetHeight)
      }

      function queryExample(fluxQuery) {
        log('\n*** QUERY ***')
        const queryApi = influxDB.getQueryApi(org)
        queryApi.queryRows(fluxQuery, {
          next(row, tableMeta) {
            const o = tableMeta.toObject(row)
            var time
            var date
            var value
            var hour
            var minute
            var second
            var timeofday
            if (o.example){
              // custom output for example query
              log(
                'testing'
                `${o._time} ${o._measurement} in '${o.location}' (${o.example}): ${o._field}=${o._value}`
              )
            } 
            
            else {
              //create matrix to draw graph
              time = new Date(Date.parse(`${o._time}`))
              value = parseFloat(JSON.parse(`${o._value}`))
              hour = time.getHours()
              minute = time.getMinutes()
              second = time.getSeconds()
              log(time + '   ' + value + '   ' + hour + ':' + minute + ':' + second)

              timeofday = [hour,minute,second]
              graph_matrix.push([timeofday, value])
            }
          },
          error(error) {
            log('QUERY FAILED', error)
          },
          complete() {
            log('QUERY FINISHED')
            drawChart(graph_matrix)
          },
        })
      }
      function onboardingExample() {
        log('\n*** ONBOARDING ***')
        const setupApi = new SetupAPI(influxDB)
        setupApi
          .getSetup()
          .then(async ({allowed}) => {
            if (allowed) {
              await setupApi.postSetup({
                body: {
                  org,
                  bucket,
                  username,
                  password,
                  token
                }
              })
              log(`InfluxDB '${url}' is now onboarded.`)
            } else {
              log(`InfluxDB '${url}' has been already onboarded.`)
            }
          })
          .catch(error => {
            log('Onboarding FAILED',error)
          })
      }

      // initialize page controls
      
      const queryInput = document.getElementById('query');
      const fluxQueryParam = new URLSearchParams(window.location.search).get('fluxQuery');
      if (fluxQueryParam){
        queryInput.value = fluxQueryParam
      }
      document.getElementById('queryButton').addEventListener('click', () => {
        queryExample(queryInput.value)
      })
      document.getElementById('onboardButton').addEventListener('click', () => {
        onboardingExample()
      })
    </script>

<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
<script type="text/javascript">
  google.charts.load('current', {'packages':['corechart']});
  google.charts.setOnLoadCallback(drawChart);

  function drawChart(matrix) {
    var data = new google.visualization.DataTable();
      data.addColumn('timeofday', 'Day');
      data.addColumn('number', 'Viscosity');

      data.addRows(matrix);

    var options = {
      title: 'Viscosity',
      width: 900,
      height: 500,
      curveType: 'function',
      legend: 'none'
    };

    var chart = new google.visualization.LineChart(document.getElementById('curve_chart'));

    chart.draw(data, options);
  }
</script>

  </head>
  <h1>Draw Graph</h1>
  <hr>
  <div>
    <button id="onboardButton">InfluxDB Onboarding</button>
  </div>
  
  <div style="display:flex; margin-bottom: 10px;">
    <textarea id="query" style="flex: 1" rows="2"
    >from(bucket:"TestingBucket") |> range(start: -1d) |> filter(fn: (r) => r._measurement == "CELLFAB-Measurement")</textarea>
  </div>
  <button id="queryButton">Query InfluxDB</button>
  <hr>
  <fieldset>
    <legend>Log</legend>
    <textarea
      id="log"
      style="width: 100%"
      rows="25"
    ></textarea>
    <button onclick="document.getElementById('log').value=''">Clear Log</button>
  </fieldset>

  <div id="curve_chart" style="width: 900px; height: 500px"></div>
</html>
